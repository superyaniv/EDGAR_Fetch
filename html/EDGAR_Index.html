<html>
<head>

	<link rel='stylesheet' href='https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css'>
	<link rel='stylesheet' href='https://cdn.datatables.net/1.10.20/css/jquery.dataTables.min.css'>
	<script src='https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js'></script>
	<script src='https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js'></script>
	<script src='https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js'></script>
	<script src='https://cdn.datatables.net/1.10.20/js/jquery.dataTables.min.js'></script>
	<style>
		.autocomplete {
			position: relative;
			display: inline-block;
		}
		.autocomplete-items {
		    position: absolute;
		    border-top: none;
		    z-index: 99;
		    top: 100%;
		    left: 0;
		    right: 0;
		}
		.autocomplete-items {
		    padding: 0px;
		    margin-left: 10px;
		    margin-right: 10px;
		    padding: 5px;
		    cursor: pointer;
		    background-color: #fff; 
		    overflow: hidden;
		    border: 1px;
		    border-radius: 20px;
		    border-style: solid;
		    box-shadow: 0 0 5px DodgerBlue;
		}
		  /*when hovering an item:*/
		.autocomplete-items div:hover {
		    background-color: #e9e9e9; 
		    border: 0px;
		    overflow: hidden;
		}

		  /*when navigating through the items using the arrow keys:*/
		.autocomplete-active {
		    background-color: DodgerBlue !important; 
		    color: #ffffff;
		}
	</style>

</head>
<body>
	<div class='jumbotron p-2 m-2' >
			<h2 class='display-4'> EDGAR SEARCH</h2>
	 	    <div class='container-fluid' style='position:relative'>
					<input id='whattoget' class='form-control w-100' placeholder='Company Name (autocomplete)' type='text' autocomplete='off' spellcheck='false'>
				</div>
				
	 	    <table class='w-100 mt-2 p-2 container-fluid' >
				<tr>
				</tr>
	 	    <tr>
			<td class='col-3'>
					<input id='whattogetCIK' class='form-control w-100' type='text' placeholder='CIK (type company name)' >
			</td>
			<td  class='col-3'>
					<input id='startdate' class='form-control w-100' type='date' name='start-date' value='2019-01-01' min='1993-01-01' max='2020-12-31'>
			</td>	
			<td class='col-3'>
				<input id='enddate' class='form-control w-100' type='date' name='end-date' value='2020-12-31' min='1993-01-01' max='2020-12-31'>
			</td>
			<td class='col-3'>
				<button id='getEDGARjson' class='btn btn-primary w-100'>
					GET
				</button>
			</td>
			</tr>

			</table>
	</div>
		<div style='padding:20px'>
		<table id='EDGAR_Table' class='table table-striped table-bordered' style='width: 100%' >
			<thead>
				<tr>
					<th>Company_Name</th>
					<th>CIK</th>
					<th>Form_Type</th>
					<th>Date_Filed</th>
					<th>Filename</th>
				</tr>
			</thead>
			<tbody>
			</tbody>
			<tfoot>
				<tr>
					<th>Company Name</th>
					<th>CIK</th>
					<th>Form_Type</th>
					<th>Date_Filed</th>
					<th>Filename</th>
				</tr>
			</tfoot>
		</table>
	</div>
</body>
	<script>
		$(document).ready(function() {
			var EDGARtable = $('#EDGAR_Table').DataTable({
					"processing": true
				});
			console.log('EDGAR/Company_Filings')
			
			$('#getEDGARjson').click(function() {

				CIKval = document.getElementById('whattogetCIK').value
				startdate = document.getElementById('startdate').value
				enddate = document.getElementById('enddate').value
				url_to_fetch = `../EDGAR/Company_Filings/${CIKval}/${startdate}/${enddate}`
				console.log(url_to_fetch);
				$.ajax({
					url: url_to_fetch,             
					dataType: 'json',                   
					success: function(data){
						EDGARtable.clear()
						data.forEach(function(item){
							console.log(item.Filename);
							EDGARtable.row.add([item.Company_Name,item.CIK,item.Form_Type,item.Date_Filed,`<a href=https://www.sec.gov/Archives/${item.Filename}>${item.Filename.split('/')[3]}</a>`]);
						})
						EDGARtable.columns.adjust().draw();
						},
					error: function(){
						console.log('error in nested ajax.');
					}
					});
			
			})
			$.ajax({
					url: '../EDGAR/Company_NamesandCIK',             
					dataType: 'json',                   
					success: function(data){
						company_names=[];
						company_ciks=[];
						data.forEach(function(item){
							console.log(item.Company_Name);
							company_names.push(item.Company_Name);
							company_ciks.push(item.CIK);
							
							//EDGARtable.row.add([item.Company_Name,item.CIK,item.Form_Type,item.Date_Filed,`<a href=https://www.sec.gov/Archives/${item.Filename}>${item.Filename.split('/')[3]}</a>`]);
							})
						autocomplete(document.getElementById('whattoget'),company_names,company_ciks);
						},
					error: function(){
					console.log('error in nested ajax.');
					}
					});
			
		function autocomplete(inp, arr,arrCIK) {
				/*the autocomplete function takes two arguments,
				the text field element and an array of possible autocompleted values:*/
					var currentFocus;
				/*execute a function when someone writes in the text field:*/
					inp.addEventListener('input', function(e) {
					var a, b, i, val = this.value;
				/*close any already open lists of autocompleted values*/
					closeAllLists();
					if (!val) { return false;}
					currentFocus = -1;
				/*create a DIV element that will contain the items (values):*/
					a = document.createElement('DIV');
					a.setAttribute('id', this.id + 'autocomplete-list');
					a.setAttribute('class', 'autocomplete-items');
				/*append the DIV element as a child of the autocomplete container:*/
					this.parentNode.appendChild(a);
				/*for each item in the array...*/

			for (i = 0; i < arr.length; i++) {
			    /*check if the item starts with the same letters as the text field value:*/
			    
			    if (arr[i].substr(0, val.length).toUpperCase() == val.toUpperCase()) {
					/*create a DIV element for each matching element:*/
						b = document.createElement('DIV');
					/*make the matching letters bold:*/
					/*insert a input field that will hold the current array item's value:*/
						b.innerHTML += `<input type='hidden' value='${arr[i]}'>`;
						b.innerHTML += `<input id='CIK' type='hidden' value='${arrCIK[i]}'>`;
						b_tr = document.createElement('TR');
						company_name_td = document.createElement('TH');
						company_name_td.classList.add('col-6');
						CIK_td = document.createElement('TH');
						CIK_td.classList.add('col-6');
						company_name_td.innerHTML = `<strong>${arr[i].substr(0, val.length)}</strong>`;
						company_name_td.innerHTML += arr[i].substr(val.length);
						CIK_td.innerHTML = arrCIK[i];
						b.appendChild(b_tr)
						b_tr.appendChild(company_name_td)
						b_tr.appendChild(CIK_td)

			      /*execute a function when someone clicks on the item value (DIV element):*/
			      	b.addEventListener('click', function(e) {
			          /*insert the value for the autocomplete text field:*/
			          inp.value = this.getElementsByTagName('input')[0].value;
			          document.getElementById('whattogetCIK').value = this.getElementsByTagName('input')[1].value;
			          /*close the list of autocompleted values,
			          (or any other open lists of autocompleted values:*/
			          closeAllLists();
			      	});
			      a.appendChild(b);
			    }
			  }
			});
				/*execute a function presses a key on the keyboard:*/
			inp.addEventListener('keydown', function(e) {
			  	
			  	var x = document.getElementById(this.id + 'autocomplete-list');
			  	
			  	if (x) x = x.getElementsByTagName('div');
		  		
		  		if (e.keyCode == 40) {
				/*If the arrow DOWN key is pressed,
				increase the currentFocus variable:*/
						currentFocus++;
				/*and and make the current item more visible:*/
						addActive(x);
				} else if (e.keyCode == 38) { //up
					/*If the arrow UP key is pressed,
					decrease the currentFocus variable:*/
					currentFocus--;
					/*and and make the current item more visible:*/
					addActive(x);
				} else if (e.keyCode == 13) {
					/*If the ENTER key is pressed, prevent the form from being submitted,*/
						e.preventDefault();
						if (currentFocus > -1) {
							/*and simulate a click on the 'active' item:*/
								if (x) x[currentFocus].click();
						}
			  	}
			});
			function addActive(x) {
				/*a function to classify an item as 'active':*/
				if (!x) return false;
				/*start by removing the 'active' class on all items:*/
				removeActive(x);
				if (currentFocus >= x.length) currentFocus = 0;
				if (currentFocus < 0) currentFocus = (x.length - 1);
				/*add class 'autocomplete-active':*/
				x[currentFocus].classList.add('autocomplete-active');
			}
			function removeActive(x) {
				/*a function to remove the 'active' class from all autocomplete items:*/
					for (var i = 0; i < x.length; i++) {
						x[i].classList.remove('autocomplete-active');
					}
			}
			function closeAllLists(elmnt) {
				/*close all autocomplete lists in the document,
				except the one passed as an argument:*/
					var x = document.getElementsByClassName('autocomplete-items');
						for (var i = 0; i < x.length; i++) {
						  if (elmnt != x[i] && elmnt != inp) {
					 			x[i].parentNode.removeChild(x[i]);
							}
						}
			}
			/*execute a function when someone clicks in the document:*/
			document.addEventListener('click', function (e) {
				closeAllLists(e.target);
			});
		}

		});


		
	</script>
</html>